<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pacotes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div id="navbar"></div>

    <main class="container py-4">
        <div class="row g-3">
            <!-- FORMULÁRIO -->
            <div class="col-12 col-xl-5">
                <div class="card">
                    <div class="card-header">Pacote</div>
                    <div class="card-body">
                        <form id="formPacote" class="row g-2">
                            <input type="hidden" id="id">

                            <div class="col-12">
                                <input id="titulo" class="form-control" placeholder="Título" required>
                            </div>
                            <div class="col-12">
                                <input id="descricaoCurta" class="form-control" placeholder="Descrição curta">
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="precoBase" type="number" step="0.01" class="form-control"
                                    placeholder="Preço base" required>
                            </div>

                            <div class="col-12">
                                <hr><strong>Passagem</strong>
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="cia" class="form-control" placeholder="Companhia">
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="origem" class="form-control" placeholder="Origem">
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="destino" class="form-control" placeholder="Destino">
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="dataIda" type="date" class="form-control">
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="dataVolta" type="date" class="form-control">
                            </div>

                            <div class="col-12">
                                <hr><strong>Hospedagem</strong>
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="hotel" class="form-control" placeholder="Hotel">
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="cidade" class="form-control" placeholder="Cidade">
                            </div>
                            <div class="col-12 col-md-6">
                                <input id="noites" type="number" class="form-control" placeholder="Noites">
                            </div>

                            <!-- Upload opcional -->
                            <div class="col-12">
                                <label class="form-label">Imagem do Pacote (opcional)</label>
                                <input id="imgFile" type="file" class="form-control" accept="image/*">
                                <div class="form-text">JPG/PNG/WebP até 2MB.</div>
                            </div>
                            <div class="col-12">
                                <img id="imgPrev" class="img-fluid rounded border d-none" alt="Pré-visualização" />
                            </div>

                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary">Salvar</button>
                                <button class="btn btn-secondary" type="button" id="btnNovo">Novo</button>
                            </div>
                            <div id="msgForm" class="text-danger small"></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- LISTA -->
            <div class="col-12 col-xl-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Lista de Pacotes</span>
                        <input id="buscaPac" class="form-control form-control-sm w-auto"
                            placeholder="Buscar título/destino..." />
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped align-middle mb-0" id="tbl">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Imagem</th>
                                        <th>Título</th>
                                        <th>Preço</th>
                                        <th>Destino</th>
                                        <th style="width:160px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="msgList" class="text-danger small mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { bootPage, getJSON, postJSON, putJSON, del } from '/js/app.js';
        await bootPage();

        let lista = [];

        function setMsg(text, where = 'form') {
            const el = where === 'list' ? document.getElementById('msgList') : document.getElementById('msgForm');
            el.textContent = text || '';
        }

        function preencherForm(p = { id: '', titulo: '', descricaoCurta: '', precoBase: '', imagemUrl: null, passagem: {}, hospedagem: {} }) {
            id.value = p.id || '';
            titulo.value = p.titulo || '';
            descricaoCurta.value = p.descricaoCurta || '';
            precoBase.value = p.precoBase || '';

            cia.value = p.passagem?.companhia || '';
            origem.value = p.passagem?.origem || '';
            destino.value = p.passagem?.destino || '';
            dataIda.value = p.passagem?.dataIda || '';
            dataVolta.value = p.passagem?.dataVolta || '';

            hotel.value = p.hospedagem?.hotel || '';
            cidade.value = p.hospedagem?.cidade || '';
            noites.value = p.hospedagem?.noites || '';

            // preview atual (se já tem imagemUrl)
            if (p.imagemUrl) {
                imgPrev.src = p.imagemUrl;
                imgPrev.classList.remove('d-none');
            } else {
                imgPrev.src = '';
                imgPrev.classList.add('d-none');
            }

            // limpar input file
            imgFile.value = '';
        }

        async function carregar() {
            setMsg('', 'list');
            try {
                lista = await getJSON('/api/pacotes');
                render(lista);
            } catch (e) {
                setMsg('Erro ao carregar: ' + (e.message || e), 'list');
            }
        }

        function render(arr) {
            const q = (buscaPac.value || '').toLowerCase();
            const dados = arr.filter(p =>
                (p.titulo || '').toLowerCase().includes(q) ||
                (p.passagem?.destino || '').toLowerCase().includes(q)
            );
            const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';

            for (const p of dados) {
                const dest = p.passagem?.destino || '';
                const thumb = p.imagemUrl
                    ? `<img src="${p.imagemUrl}" alt="imagem" style="width:60px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">`
                    : '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${p.id}</td>
          <td>${thumb}</td>
          <td>${p.titulo}</td>
          <td>${p.precoBase}</td>
          <td>${dest}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-warning" data-edit="${p.id}">Editar</button>
            <button class="btn btn-sm btn-danger" data-del="${p.id}">Excluir</button>
          </td>`;
                tb.appendChild(tr);
            }

            tb.querySelectorAll('button[data-edit]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const item = lista.find(x => x.id == btn.dataset.edit);
                    preencherForm(item);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
            tb.querySelectorAll('button[data-del]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!confirm('Excluir pacote?')) return;
                    try {
                        await del('/api/pacotes/' + btn.dataset.del);
                        carregar();
                    } catch (e) {
                        setMsg('Erro ao excluir: ' + (e.message || e), 'list');
                    }
                });
            });
        }

        // Upload opcional da imagem após salvar
        async function uploadImagemSeSelecionada(pacoteId) {
            const file = imgFile.files?.[0];
            if (!file) return; // nada a enviar

            const fd = new FormData();
            fd.append('file', file);

            const r = await fetch(`/api/pacotes/${pacoteId}/imagem`, {
                method: 'POST',
                body: fd,
                credentials: 'include'
            });

            if (!r.ok) {
                let msg = '';
                try { msg = await r.text(); } catch { }
                throw new Error(`Falha no upload: ${msg}`);
            }

            const atualizado = await r.json();
            if (atualizado.imagemUrl) {
                imgPrev.src = atualizado.imagemUrl;
                imgPrev.classList.remove('d-none');
            }
        }

        formPacote.addEventListener('submit', async e => {
            e.preventDefault();
            setMsg('');

            const body = {
                titulo: titulo.value,
                descricaoCurta: descricaoCurta.value,
                precoBase: Number(precoBase.value || 0),
                passagem: {
                    companhia: cia.value, origem: origem.value, destino: destino.value,
                    dataIda: dataIda.value || null, dataVolta: dataVolta.value || null
                },
                hospedagem: { hotel: hotel.value, cidade: cidade.value, noites: Number(noites.value || 0) }
            };

            try {
                let salvo;
                if (id.value) {
                    salvo = await putJSON('/api/pacotes/' + id.value, body);
                } else {
                    salvo = await postJSON('/api/pacotes', body);
                }

                // faz o upload se o usuário selecionou um arquivo
                await uploadImagemSeSelecionada(salvo.id);

                // recarrega lista e reseta form
                preencherForm();
                carregar();
            } catch (err) {
                setMsg('Erro ao salvar: ' + (err.message || err));
            }
        });

        imgFile?.addEventListener('change', () => {
            const f = imgFile.files?.[0];
            if (!f) { imgPrev.classList.add('d-none'); imgPrev.src = ''; return; }
            const url = URL.createObjectURL(f);
            imgPrev.src = url;
            imgPrev.classList.remove('d-none');
        });

        btnNovo.addEventListener('click', () => preencherForm());
        buscaPac.addEventListener('input', () => render(lista));

        carregar();
    </script>
</body>

</html>